<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–µå–µé»é»æ¨‚ï¼šåœ°åœ–æ¨¡å¼æ¶ˆé™¤éŠæˆ²</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* éŠæˆ²å°ˆç”¨è‡ªè¨‚æ¨£å¼ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #2c2834; /* æ·±è‰²è–°è¡£è‰ç´«/è— */
            height: 100vh; /* Full viewport height */
            margin: 0;
            overflow: hidden; /* Prevent scrollbars */
        }
        #game-container {
            width: 100%;
            height: 100vh; /* Full viewport height */
            margin: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* è®“æ¨™é¡Œä½æ–¼é ‚éƒ¨ */
            padding: 1rem;
            box-sizing: border-box; /* åŒ…å« padding åœ¨å…§çš„ 100vh */
        }
        #game-canvas {
            border: 4px solid #b794f4; /* é‚Šæ¡†ä½¿ç”¨è²“å’ªä¸»é¡Œè‰² (æ·ºç´«) */
            background-color: #f9f7e8; /* æ·ºé»ƒ/ç±³ç™½ï¼Œåƒè²“ç ‚æˆ–å¢Šå­ */
            border-radius: 12px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            touch-action: manipulation; /* ç¦ç”¨ç€è¦½å™¨è§¸æ‘¸æ“ä½œï¼Œæé«˜éŠæˆ²éŸ¿æ‡‰ */
            display: block;
            max-width: 100%;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: all 0.2s;
            background-color: #f687b3; /* Pink-400 */
            box-shadow: 0 4px #e53e7a; /* Pink-600 */
            transform: translateY(0);
        }
        .btn:hover {
            opacity: 0.9;
            box-shadow: 0 6px #e53e7a;
        }
        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px #e53e7a;
        }

        /* å®Œæˆç•«é¢çš„é¡è‰² */
        .complete-bg {
            background-color: #48bb78; /* ç¶ è‰²ï¼Œè¡¨ç¤ºæˆåŠŸ */
        }
        
        /* å»£å‘Šç‰ˆä½æ¨£å¼ (Placeholder) */
        .ad-slot {
            margin: 1.5rem auto;
            width: 90%;
            max-width: 728px;
            height: 90px;
            background-color: #333;
            color: #ccc;
            border: 2px dashed #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        /* é‡å°å°è¢å¹•èª¿æ•´å»£å‘Šé«˜åº¦ */
        @media (max-width: 600px) {
             .ad-slot {
                height: 50px;
             }
        }

        /* --- åœ°åœ–æ¨¡å¼ CSS (ç°¡åŒ–ç‰ˆ) --- */
        #menu-view {
            overflow-x: hidden; 
            overflow-y: scroll; 
            max-height: 90vh; /* åœ¨èœå–®æ¨¡å¼ä¸‹ä»ç„¶é™åˆ¶é«˜åº¦ */
        }
        
        #level-map-container {
            position: relative;
            width: 100%;
            min-height: 800px; 
            padding: 2rem 0;
            margin: auto;
        }

        /* è·¯å¾‘ç·š (Path Line) - ä½æ–¼ä¸­å¤® */
        #level-map-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%; /* ä¸­å¤®å°é½Š */
            transform: translateX(-50%);
            width: 8px; /* è·¯å¾‘ç²—ç´° */
            height: 100%;
            background-color: #63b3ed; /* è—è‰²è·¯å¾‘ */
            border-radius: 4px;
            z-index: 10;
        }

        /* é—œå¡ç¯€é» (å¤§é—œå¡) */
        .map-node {
            position: absolute;
            width: 72px;
            height: 72px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            line-height: 1.1;
            cursor: pointer;
            border: 4px solid #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            z-index: 20; /* ä½æ–¼è·¯å¾‘ç·šä¸Šæ–¹ */
        }
        
        .map-node:hover:not(.locked) {
            transform: scale(1.15) !important;
            box-shadow: 0 6px 15px rgba(255, 255, 255, 0.4);
        }
        
        /* ç¯€é»ç‹€æ…‹ */
        .map-node.unlocked {
            background-color: #48bb78; /* è²“è–„è·ç¶  (å¯ç©) */
            border-color: #f6ad55; /* æ©™è‰²é‚Šæ¡† (å¼·èª¿) */
        }
        .map-node.completed {
            background-color: #38b2ac; /* é’è‰² (å·²å®Œæˆ) */
            border-color: #4c51bf; /* æ·±è—è‰²é‚Šæ¡† */
        }
        .map-node.locked {
            background-color: #718096; /* ç°è‰² (é–å®š) */
            opacity: 0.6;
            cursor: not-allowed;
            border-color: #4a5568;
        }

        /* è„ˆè¡å‹•ç•« - ç”¨æ–¼ä¸‹ä¸€å€‹å¯ç©é—œå¡ */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(246, 173, 85, 0.7); }
            100% { box-shadow: 0 0 0 15px rgba(246, 173, 85, 0); }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <!-- éŠæˆ²ä¸»æ¨™é¡Œ -->
        <h1 class="text-4xl font-extrabold text-white mb-6 text-center">ğŸ¾ å–µå–µé»é»æ¨‚ï¼šæ¶ˆé™¤è²“çƒï¼ ğŸ¾</h1>

        <!-- éŠæˆ²ä¸»ä»‹é¢ -->
        <div id="game-screen" class="w-full relative flex-grow flex flex-col items-center justify-center"> 
            <!-- é ‚éƒ¨å»£å‘Šå€å¡Š -->
            <div id="ad-banner-top" class="ad-slot">
                [æ‚¨çš„å»£å‘Šç¨‹å¼ç¢¼å°‡æ”¾åœ¨æ­¤è™•] - ä¾‹å¦‚ Google AdSense
            </div>
            
            <!-- é—œå¡é¸å–® (åœ°åœ–è¦–åœ–) -->
            <div id="menu-view" class="p-4 bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-auto relative">
                <h2 class="text-2xl font-bold text-white mb-4 text-center">ğŸ—ºï¸ é€—è²“åœ°åœ– ğŸ—ºï¸</h2>
                <!-- åœ°åœ–å…§å®¹å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ (åªæœ‰å¤§é—œå¡ç¯€é») -->
                <div id="level-map-container" class="relative">
                    <!-- Map Nodes will be generated here -->
                </div>
            </div>

            <!-- å­é—œå¡é¸å–® (Overlay/Modal) - çµ•å°å®šä½æ–¼ game-screen å…§éƒ¨ -->
            <div id="sub-level-view" class="hidden absolute inset-0 z-30 bg-gray-900 bg-opacity-90 flex items-center justify-center p-4">
                <div class="bg-gray-700 p-6 rounded-xl shadow-2xl w-full max-w-sm">
                    <h3 id="sub-level-title" class="text-3xl font-bold text-white mb-4 text-center"></h3>
                    <div id="sub-levels-list" class="space-y-3">
                        <!-- Sub-level buttons go here -->
                    </div>
                    <button class="btn w-full text-white mt-6 bg-red-500 shadow-md shadow-red-700 hover:bg-red-600" onclick="hideSubLevelSelection()">è¿”å›åœ°åœ–</button>
                </div>
            </div>

            <!-- éŠæˆ²é€²è¡Œä¸­ç•«é¢ (éš±è—ç‹€æ…‹) -->
            <div id="game-view" class="hidden flex-col items-center justify-center flex-grow w-full">
                <div class="text-white text-xl font-bold mb-3">
                    é—œå¡ <span id="current-level-display">1-1</span> - å‰©é¤˜ç›®æ¨™: 
                    <span id="ball-count">10</span>
                </div>
                <canvas id="game-canvas"></canvas>
            </div>

            <!-- é—œå¡å®Œæˆç•«é¢ (éš±è—ç‹€æ…‹) -->
            <div id="complete-view" class="hidden p-8 complete-bg rounded-xl shadow-2xl text-white text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="text-4xl font-extrabold mb-4">ğŸ‰ è²“å’ªå¤§æ»¿è¶³ï¼ ğŸ‰</h2>
                <p id="completion-message" class="text-xl mb-6">æ‚¨æˆåŠŸé€—æ¨‚äº†æ‰€æœ‰æ¯›ç·šçƒï¼</p>
                <!-- å®Œæˆç•«é¢å°å»£å‘Š -->
                <div id="ad-banner-complete" class="ad-slot h-20 text-sm max-w-sm">
                    [æ‚¨çš„å»£å‘Šç¨‹å¼ç¢¼å°‡æ”¾åœ¨æ­¤è™•] - å®Œæˆç•«é¢
                </div>
                <button class="btn text-white mt-4" onclick="showMenu()">è¿”å›åœ°åœ–</button>
            </div>
        </div>
    </div>

    <script>
        // --- éŠæˆ²ç‹€æ…‹è®Šæ•¸èˆ‡é…ç½® ---
        const STORAGE_KEY = 'catGameProgress_v2';
        let gameState = 'MENU'; // MENU, PLAYING, COMPLETE
        let currentLevel = { big: 1, sub: 1, config: null };
        let balls = [];
        let canvas, ctx;
        let animationFrameId;
        let completedLevel = '0-0'; // B-S æ ¼å¼. '0-0' è¡¨ç¤ºå°šæœªå®Œæˆä»»ä½•é—œå¡

        // é—œå¡åœ°åœ–é…ç½®
        const levelMap = {
            1: { // å¤§é—œå¡ 1: æ¯›ç·šçƒ (Yarn Balls)
                theme: "æ¯›ç·šçƒä¸»é¡Œ",
                icon: "ğŸ§¶",
                subLevels: [
                    { id: '1-1', balls: 10, speed: 3.0, description: "åŸºç¤è¨“ç·´" },
                    { id: '1-2', balls: 12, speed: 3.5, description: "è¼•å·§åŠ é€Ÿ" },
                    { id: '1-3', balls: 15, speed: 4.0, description: "æ•¸é‡èˆ‡é€Ÿåº¦" },
                    { id: '1-4', balls: 18, speed: 4.5, description: "æ¥µé™æŒ‘æˆ°" },
                    { id: '1-5', balls: 20, speed: 5.0, description: "è²“çƒå¤§å¸«" }
                ],
                radius: { min: 15, max: 25 },
                colors: ['#f687b3', '#ecc94b', '#4fd1c5', '#b794f4', '#fc8181']
            },
            2: { // å¤§é—œå¡ 2: å°æ˜†èŸ² (Small Insects)
                theme: "å°æ˜†èŸ²ä¸»é¡Œ",
                icon: "ğŸ",
                subLevels: [
                    { id: '2-1', balls: 15, speed: 5.5, description: "å—¡å—¡ä½œéŸ¿" },
                    { id: '2-2', balls: 17, speed: 6.0, description: "æ€¥é€Ÿé£›è¡Œ" },
                    { id: '2-3', balls: 20, speed: 6.5, description: "é›£ä»¥æ•æ‰" },
                    { id: '2-4', balls: 22, speed: 7.0, description: "ç¾¤é«”äº‚èˆ" },
                    { id: '2-5', balls: 25, speed: 7.5, description: "æ˜†èŸ²ä¹‹ç‹" }
                ],
                radius: { min: 10, max: 20 }, // è¼ƒå°ï¼Œé›£åº¦å¢åŠ 
                colors: ['#48bb78', '#a0aec0', '#d69e2e', '#4299e1']
            },
            3: { // å¤§é—œå¡ 3: è€é¼  (Mice)
                theme: "è€é¼ ä¸»é¡Œ",
                icon: "ğŸ­",
                subLevels: [
                    { id: '3-1', balls: 20, speed: 8.0, description: "è§’è½å·è·‘" },
                    { id: '3-2', balls: 25, speed: 8.5, description: "é–ƒé›»ç©¿æ¢­" },
                    { id: '3-3', balls: 30, speed: 9.0, description: "ç„¡å½±ç„¡è¹¤" },
                    { id: '3-4', balls: 35, speed: 9.5, description: "é™·é˜±é å‚™" },
                    { id: '3-5', balls: 40, speed: 10.0, description: "é¼ ç‹é™è‡¨" }
                ],
                radius: { min: 18, max: 30 }, // æ··é›œå¤§å°
                colors: ['#cbd5e0', '#718096', '#2d3748', '#f56565']
            }
        };

        // --- é€²åº¦ç®¡ç†å‡½æ•¸ (ä½¿ç”¨ Local Storage) ---

        function loadProgress() {
            try {
                const storedLevel = localStorage.getItem(STORAGE_KEY);
                if (storedLevel && storedLevel !== 'MAX') {
                    completedLevel = storedLevel;
                } else if (storedLevel === 'MAX') {
                    completedLevel = 'MAX'; 
                } else {
                    completedLevel = '0-0'; // åˆå§‹ç‹€æ…‹
                }
            } catch (e) {
                console.error("ç„¡æ³•è¼‰å…¥é€²åº¦:", e);
                completedLevel = '0-0';
            }
        }

        function saveProgress(levelId) {
             try {
                localStorage.setItem(STORAGE_KEY, levelId);
                completedLevel = levelId;
            } catch (e) {
                console.error("ç„¡æ³•å„²å­˜é€²åº¦:", e);
            }
        }

        // å–å¾—ç›®æ¨™é—œå¡çš„å‰ä¸€é—œ ID
        function getPreviousLevelId(targetId) {
            const parts = targetId.split('-').map(Number);
            let big = parts[0];
            let sub = parts[1];

            if (sub > 1) {
                return `${big}-${sub - 1}`;
            } else if (big > 1) {
                // é€²å…¥æ–°å¤§é—œå¡çš„ç¬¬ä¸€å€‹å°é—œå¡ï¼Œå‰ä¸€é—œæ˜¯ä¸Šä¸€å€‹å¤§é—œå¡çš„æœ€å¾Œä¸€å€‹å°é—œå¡
                const prevBigLevelConfig = levelMap[big - 1];
                const lastSub = prevBigLevelConfig ? prevBigLevelConfig.subLevels.length : 5;
                return `${big - 1}-${lastSub}`;
            } else {
                // é—œå¡ 1-1 çš„å‰ä¸€é—œæ˜¯ '0-0'
                return '0-0'; 
            }
        }

        // æª¢æŸ¥ç›®æ¨™é—œå¡æ˜¯å¦å·²è§£é– (å‰ä¸€é—œæ˜¯å¦å·²å®Œæˆ)
        function isLevelUnlocked(targetId) {
            if (targetId === '1-1') return true; // 1-1 æ°¸é è§£é–
            if (completedLevel === 'MAX') return true; // å¦‚æœå·²ç¶“å…¨ç ´ï¼Œæ‰€æœ‰é—œå¡éƒ½å¯ç©

            const previousId = getPreviousLevelId(targetId);
            // é—œå¡å·²è§£é–çš„æ¢ä»¶ï¼šå‰ä¸€é—œå·²ç¶“è¢«æ¨™è¨˜ç‚º 'completedLevel'
            return isLevelCompleted(previousId);
        }

        // æª¢æŸ¥ç›®æ¨™é—œå¡æ˜¯å¦å·²å®Œæˆ (è‡ªå·±æ˜¯å¦å·²æ¨™è¨˜ç‚º completedLevel)
        function isLevelCompleted(targetId) {
            // å¦‚æœç•¶å‰å®Œæˆçš„é—œå¡ ID ç­‰æ–¼æˆ–å¤§æ–¼ç›®æ¨™é—œå¡ IDï¼Œå‰‡è¦–ç‚ºå·²å®Œæˆ
            if (completedLevel === 'MAX') return true;

            const [targetB, targetS] = targetId.split('-').map(Number);
            const [compB, compS] = completedLevel.split('-').map(Number);
            
            if (compB > targetB) return true;
            if (compB === targetB && compS >= targetS) return true;
            return false;
        }

        // --- éŠæˆ²ä»‹é¢èˆ‡æµç¨‹å‡½æ•¸ (åœ°åœ–æ¨¡å¼) ---

        // å‹•æ…‹ç”Ÿæˆå¤§é—œå¡åœ°åœ– UI
        function renderLevelMap() {
            const mapContainer = document.getElementById('level-map-container');
            mapContainer.innerHTML = '';
            
            const bigLevelKeys = Object.keys(levelMap).map(Number);
            const TOTAL_BIG_LEVELS = bigLevelKeys.length;
            const VERTICAL_SPACING = 150; // èª¿æ•´å¤§é—œå¡é–“è·
            const CONTAINER_HEIGHT = TOTAL_BIG_LEVELS * VERTICAL_SPACING + 100; 
            mapContainer.style.height = `${CONTAINER_HEIGHT}px`;

            bigLevelKeys.forEach((big, index) => {
                const firstLevelId = `${big}-1`;
                // æª¢æŸ¥æ˜¯å¦å·²è§£é– (åªéœ€æª¢æŸ¥è©²å¤§é—œå¡çš„ç¬¬ä¸€å€‹å°é—œå¡æ˜¯å¦è§£é–)
                const isBigLevelUnlocked = isLevelUnlocked(firstLevelId);
                // æª¢æŸ¥æ˜¯å¦å·²å®Œæˆ (æª¢æŸ¥è©²å¤§é—œå¡çš„æœ€å¾Œä¸€å€‹å°é—œå¡æ˜¯å¦å®Œæˆ)
                const isBigLevelCompleted = isLevelCompleted(`${big}-5`); 
                
                let levelClass = isBigLevelCompleted ? 'completed' : (isBigLevelUnlocked ? 'unlocked' : 'locked');
                
                // çªå‡ºé¡¯ç¤ºä¸‹ä¸€å€‹è¦è§£é–çš„å¤§é—œå¡ (å³ç¬¬ä¸€å€‹æœªå®Œæˆä¸”å·²è§£é–çš„å¤§é—œå¡)
                const isCurrentNext = isBigLevelUnlocked && !isBigLevelCompleted;
                
                // å¾åº•éƒ¨å¾€ä¸Šæ’ï¼Œè®“ 1 åœ¨æœ€ä¸‹é¢
                const positionIndex = (TOTAL_BIG_LEVELS - 1) - index; 
                const top = positionIndex * VERTICAL_SPACING + 20; 

                // å·¦å³äº¤éŒ¯è·¯å¾‘
                const isZigZagLeft = index % 2 === 0; 
                const leftPercent = isZigZagLeft ? 20 : 80; 
                
                // æª¢æŸ¥å¤§é—œå¡æ˜¯å¦å¯é»æ“Š (å·²è§£é–æˆ–å·²å®Œæˆ)
                const isLevelAccessible = isBigLevelUnlocked || isBigLevelCompleted;

                const nodeContent = `<div class="text-sm">ç¬¬ ${big} å€</div>
                                     <div class="text-3xl">${levelMap[big].icon}</div>
                                     <div class="text-xs font-normal">${levelMap[big].theme}</div>`;

                const pulseStyle = isCurrentNext ? 'animation: pulse 1s infinite alternate;' : '';

                const nodeHtml = `
                    <div 
                        id="big-node-${big}"
                        class="map-node ${levelClass} transform -translate-x-1/2" 
                        style="top: ${top}px; left: ${leftPercent}%; ${pulseStyle}"
                        onclick="${isLevelAccessible ? `showSubLevelSelection(${big})` : ''}"
                        title="${levelMap[big].theme} (${isLevelAccessible ? 'é»æ“Šé¸æ“‡é—œå¡' : 'é–å®š'})"
                    >
                        ${nodeContent}
                    </div>
                `;
                mapContainer.insertAdjacentHTML('beforeend', nodeHtml);
                
                // æ»¾å‹•åˆ°ç¬¬ä¸€å€‹æœªå®Œæˆä¸”å·²è§£é–çš„é—œå¡
                if (isCurrentNext) {
                    setTimeout(() => {
                        const nodeElement = document.getElementById(`big-node-${big}`);
                        if (nodeElement) {
                            nodeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                }
            });

            // è™•ç†ã€Œå…¨ç ´ã€ç‹€æ…‹çš„é¡å¤–æç¤º (ä¾‹å¦‚çµ‚é»)
            if (completedLevel === 'MAX') {
                const endTop = -10;
                const endHtml = `
                    <div class="map-node completed big-icon transform -translate-x-1/2"
                         style="top: ${endTop}px; left: 50%;">
                        <div class="text-3xl">ğŸ†</div>
                        <div class="text-xs">å·²å…¨ç ´</div>
                    </div>
                `;
                mapContainer.insertAdjacentHTML('beforeend', endHtml);
            }
        }

        // é¡¯ç¤ºå­é—œå¡é¸å–®
        function showSubLevelSelection(big) {
            const themeConfig = levelMap[big];
            const subView = document.getElementById('sub-level-view');
            const title = document.getElementById('sub-level-title');
            const list = document.getElementById('sub-levels-list');

            title.textContent = `${themeConfig.icon} ç¬¬ ${big} å€ï¼š${themeConfig.theme}`;
            list.innerHTML = '';

            themeConfig.subLevels.forEach(subConfig => {
                const levelId = subConfig.id;
                const unlocked = isLevelUnlocked(levelId);
                const completed = isLevelCompleted(levelId);
                
                let levelClass = completed ? 'bg-teal-500 shadow-teal-700' : 
                                 (unlocked ? 'bg-green-500 shadow-green-700' : 'bg-gray-500 cursor-not-allowed opacity-70 shadow-gray-700');
                
                let levelText = `${levelId}: ${subConfig.description}`;
                if (completed) levelText += ' (âœ” å·²å®Œæˆ)';
                if (!unlocked) levelText += ' (ğŸ”’)';

                const buttonHtml = `
                    <button class="w-full p-3 rounded-lg text-white font-semibold shadow-md transition-all ${levelClass}"
                        onclick="${unlocked || completed ? `startGame(${big}, ${subConfig.id.split('-')[1]}, true);` : ''}"
                        ${unlocked || completed ? '' : 'disabled'}
                    >
                        ${levelText}
                    </button>
                `;
                list.insertAdjacentHTML('beforeend', buttonHtml);
            });

            subView.classList.remove('hidden');
        }

        // éš±è—å­é—œå¡é¸å–®
        function hideSubLevelSelection() {
            document.getElementById('sub-level-view').classList.add('hidden');
        }


        // é¡¯ç¤ºé¸å–®ç•«é¢
        function showMenu() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            gameState = 'MENU';
            document.getElementById('menu-view').classList.remove('hidden');
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('complete-view').classList.add('hidden');
            
            // ç¢ºä¿é ‚éƒ¨å»£å‘Šåœ¨èœå–®æ™‚å¯è¦‹
            document.getElementById('ad-banner-top').classList.remove('hidden');
            hideSubLevelSelection(); // ç¢ºä¿è¿”å›åœ°åœ–æ™‚å­é¸å–®æ˜¯éš±è—çš„

            renderLevelMap(); // è¿”å›é¸å–®æ™‚é‡æ–°æ¸²æŸ“åœ°åœ–
        }

        // æ ¹æ“šé—œå¡é…ç½®ç”Ÿæˆçƒé«”
        function initLevel(config) {
            balls = [];
            const { balls: ballCount, speed: maxSpeed } = config.subConfig;
            const { min: minRadius, max: maxRadius } = config.themeConfig.radius;
            const colors = config.themeConfig.colors;

            // æ›´æ–°é¡¯ç¤º
            document.getElementById('ball-count').textContent = ballCount;
            document.getElementById('current-level-display').textContent = config.subConfig.id;

            // ç”Ÿæˆçƒ
            for (let i = 0; i < ballCount; i++) {
                const r = Math.random() * (maxRadius - minRadius) + minRadius;
                const x = Math.random() * (canvas.width - 2 * r) + r;
                const y = Math.random() * (canvas.height - 2 * r) + r;
                // éš¨æ©Ÿé€Ÿåº¦ (æœ€å°ç‚º 0.5)
                const dx = (Math.random() * maxSpeed * 2 - maxSpeed) || (Math.random() > 0.5 ? 0.5 : -0.5); 
                const dy = (Math.random() * maxSpeed * 2 - maxSpeed) || (Math.random() > 0.5 ? 0.5 : -0.5);
                const color = colors[i % colors.length];

                balls.push(new Ball(x, y, r, dx, dy, color));
            }
        }

        // å•Ÿå‹•éŠæˆ²
        function startGame(big, sub, isAllowed) {
            if (!isAllowed) {
                console.log(`é—œå¡ ${big}-${sub} å°šæœªè§£é–ï¼`);
                return;
            }

            const themeConfig = levelMap[big];
            const subConfig = themeConfig.subLevels[sub - 1];

            currentLevel.big = big;
            currentLevel.sub = sub;
            currentLevel.config = { themeConfig, subConfig };
            gameState = 'PLAYING';
            
            // éš±è—å­é—œå¡é¸å–®
            hideSubLevelSelection();

            // åˆ‡æ›ç•«é¢
            document.getElementById('menu-view').classList.add('hidden');
            document.getElementById('complete-view').classList.add('hidden');
            document.getElementById('game-view').classList.remove('hidden');
            // game-view å·²ç¶“åœ¨ HTML ä¸­è¨­å®šç‚º flex-grow

            // éš±è—é ‚éƒ¨å»£å‘Š
            document.getElementById('ad-banner-top').classList.add('hidden');

            resizeCanvas(); 
            initLevel(currentLevel.config);
            gameLoop();
        }

        // éŠæˆ²å®Œæˆ
        function completeGame() {
            gameState = 'COMPLETE';
            cancelAnimationFrame(animationFrameId);
            
            const currentId = `${currentLevel.big}-${currentLevel.sub}`;
            
            let message = `æ‚¨æˆåŠŸé€—æ¨‚äº†æ‰€æœ‰æ¯›ç·šçƒï¼`;

            if (!isLevelCompleted(currentId)) {
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡é€šé—œï¼Œå‰‡æ›´æ–°é€²åº¦
                saveProgress(currentId); 
                const nextId = getNextLevelId(currentId);
                
                if (nextId === 'MAX') {
                    message = 'ğŸ† æ­å–œæ‚¨ï¼æ‰€æœ‰é—œå¡éƒ½å·²å®Œæˆï¼Œæ‚¨æ˜¯æœ€æ£’çš„è²“å’ªå¤§å¸«ï¼ ğŸ†';
                    saveProgress('MAX'); // æ¨™è¨˜ç‚ºå…¨ç ´
                } else {
                    message += ` æ­å–œï¼æ‚¨å·²è§£é–ä¸‹ä¸€é—œ ${nextId}ï¼`;
                }
            } else {
                message += ` (æœ¬é—œå·²é‡è¤‡æŒ‘æˆ°æˆåŠŸ)`;
            }
            
            document.getElementById('completion-message').textContent = message;

            // åˆ‡æ›ç•«é¢
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('complete-view').classList.remove('hidden');
            
            // ç¢ºä¿å®Œæˆç•«é¢çš„å»£å‘Šå¯è¦‹
            document.getElementById('ad-banner-complete').classList.remove('hidden');
        }

        // å–å¾—ä¸‹ä¸€å€‹é—œå¡ ID
        function getNextLevelId(currentId) {
            const parts = currentId.split('-').map(Number);
            let big = parts[0];
            let sub = parts[1];

            if (sub < 5) {
                // ç§»è‡³ç•¶å‰å¤§é—œå¡çš„ä¸‹ä¸€å€‹å°é—œå¡
                sub++;
                return `${big}-${sub}`;
            } else if (levelMap[big + 1]) {
                // ç§»è‡³ä¸‹ä¸€å€‹å¤§é—œå¡çš„ç¬¬ä¸€å€‹å°é—œå¡
                big++;
                return `${big}-1`;
            } else {
                // éŠæˆ²å®Œå…¨å®Œæˆ
                return 'MAX';
            }
        }

        // --- æ ¸å¿ƒéŠæˆ²å…ƒä»¶ (Ball Class & Loop) ---

        // çƒé«”é¡åˆ¥ (Ball Class)
        class Ball {
            constructor(x, y, r, dx, dy, color) {
                this.x = x; 
                this.y = y; 
                this.r = r; 
                this.dx = dx; 
                this.dy = dy; 
                this.color = color; 
                this.isAlive = true;
            }

            draw() {
                if (!this.isAlive) return;
                
                // ä¸»é«”
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
                ctx.shadowBlur = this.r / 2;
                ctx.fill();
                ctx.closePath();
                
                ctx.shadowBlur = 0; 
                
                // äº®é»/ç´‹ç† (è®“å®ƒçœ‹èµ·ä¾†åƒå€‹æ¯›ç·š/ç©å…·)
                ctx.beginPath();
                ctx.arc(this.x + this.r / 3, this.y - this.r / 3, this.r / 5, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.fill();
                ctx.closePath();
            }

            update() {
                if (!this.isAlive) return;

                // ç¢°æ’é‚Šç•Œæª¢æ¸¬ (X è»¸)
                if (this.x + this.r > canvas.width || this.x - this.r < 0) {
                    this.dx = -this.dx;
                    if (this.x + this.r > canvas.width) this.x = canvas.width - this.r;
                    if (this.x - this.r < 0) this.x = this.r;
                }

                // ç¢°æ’é‚Šç•Œæª¢æ¸¬ (Y è»¸)
                if (this.y + this.r > canvas.height || this.y - this.r < 0) {
                    this.dy = -this.dy;
                    if (this.y + this.r > canvas.height) this.y = canvas.height - this.r;
                    if (this.y - this.r < 0) this.y = this.r;
                }

                this.x += this.dx;
                this.y += this.dy;
            }
        }

        function gameLoop() {
            if (gameState !== 'PLAYING') {
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let i = 0; i < balls.length; i++) {
                const ball = balls[i];
                ball.update();
                ball.draw();
            }
            
            animationFrameId = requestAnimationFrame(gameLoop);
        }
        
        // è™•ç†æ»‘é¼ /è§¸æ‘¸è¼¸å…¥
        function handleInput(event) {
            if (gameState !== 'PLAYING') return;
            
            if (event.type === 'touchstart') {
                event.preventDefault(); 
            }

            let clientX, clientY;
            if (event.type === 'touchstart') {
                clientX = event.touches[0].clientX;
                clientY = event.touches[0].clientY;
            } else { 
                clientX = event.clientX;
                clientY = event.clientY;
            }

            const rect = canvas.getBoundingClientRect();
            const clickX = clientX - rect.left;
            const clickY = clientY - rect.top;

            let hit = false;
            // å€’åºéæ­·çƒé«”
            for (let i = balls.length - 1; i >= 0; i--) {
                const ball = balls[i];
                if (!ball.isAlive) continue;

                const distance = Math.sqrt(Math.pow(ball.x - clickX, 2) + Math.pow(ball.y - clickY, 2));

                if (distance <= ball.r) {
                    ball.isAlive = false; 
                    hit = true;
                    break;
                }
            }

            if (hit) {
                updateBallCountDisplay();
                checkGameCompletion();
            }
        }

        function updateBallCountDisplay() {
            const aliveBalls = balls.filter(b => b.isAlive).length;
            document.getElementById('ball-count').textContent = aliveBalls;
        }

        function checkGameCompletion() {
            const remainingBalls = balls.filter(b => b.isAlive).length;
            if (remainingBalls === 0) {
                completeGame();
            }
        }

        // --- åˆå§‹åŒ– ---

        function setupGame() {
            canvas = document.getElementById('game-canvas');
            ctx = canvas.getContext('2d');
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            canvas.addEventListener('mousedown', handleInput);
            canvas.addEventListener('touchstart', handleInput, { passive: true });
            
            loadProgress(); // è¼‰å…¥ä¹‹å‰å®Œæˆçš„æœ€é«˜é—œå¡
            showMenu(); // é¡¯ç¤ºåœ°åœ–
        }

        function resizeCanvas() {
            const container = document.getElementById('game-view');
            
            // æ‰¾å‡º UI å…ƒç´ çš„é«˜åº¦ (é—œå¡/åˆ†æ•¸é¡¯ç¤º)
            const uiBar = container.querySelector('div');
            const uiBarHeight = uiBar ? uiBar.offsetHeight + 12 : 0; // + 12 for margin-bottom

            // ç²å–å®¹å™¨çš„å¯ç”¨ç©ºé–“
            const availableWidth = container.clientWidth;
            // æ¸›å» UI æ¬„çš„é«˜åº¦å’Œä¸€äº›å®‰å…¨é–“è·
            const availableHeight = container.clientHeight - uiBarHeight - 20; 
            
            // è¨­ç½®ç‚ºå¯ç”¨çš„æœ€å¤§æ­£æ–¹å½¢
            let size = Math.min(availableWidth, availableHeight);

            const oldWidth = canvas.width;
            const oldHeight = canvas.height;
            
            canvas.width = size;
            canvas.height = size;
            
            if (gameState === 'PLAYING' && oldWidth > 0 && oldHeight > 0) {
                // èª¿æ•´çƒé«”ä½ç½®ä»¥é©æ‡‰æ–°çš„ç•«å¸ƒå¤§å°
                balls.forEach(ball => {
                    ball.x = ball.x * (size / oldWidth);
                    ball.y = ball.y * (size / oldHeight);
                    // ç¢ºä¿çƒä¸æœƒè¢«æ“ å‡ºæ–°ç•«å¸ƒé‚Šç•Œ
                    ball.x = Math.max(ball.r, Math.min(ball.x, size - ball.r));
                    ball.y = Math.max(ball.r, Math.min(ball.y, size - ball.r));
                });
            }
        }
        
        // ç¢ºä¿åœ¨è¦–çª—è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        window.onload = setupGame;

    </script>
</body>
</html>
